<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD.PERUS - Regional 2 - Santa Maria</title>
    
    <!-- Scripts Externos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #ffffff;
            color: #000000;
        }

        @media print {
            @page { size: A4 landscape; margin: 0; }
            body > *:not(#printContainer) { display: none !important; }
            #printContainer { display: block !important; width: 100%; }
            .print-page { page-break-after: always; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #000000; border-radius: 10px; }
        
        .card-clean {
            background-color: #ffffff;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-exit { background-color: #ef4444; color: white; }
    </style>
</head>
<body class="transition-colors duration-300 antialiased">

    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 right-0 h-16 bg-white border-b border-gray-100 z-50 px-6 flex items-center justify-between print-hidden">
        <div class="flex items-center gap-3">
            <div class="bg-black p-2 rounded-xl text-white">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-black uppercase leading-none tracking-tight text-black">AD.PERUS</h1>
                <p class="text-[10px] font-bold text-gray-400 tracking-widest uppercase">Regional 2 - Santa Maria</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="sync-status" class="flex items-center gap-2 px-3 py-1 bg-gray-50 rounded-full text-[10px] font-bold uppercase tracking-tighter text-black">
                <span id="sync-dot" class="w-2 h-2 bg-gray-300 rounded-full"></span> <span id="sync-text">Conectando...</span>
            </div>
        </div>
    </nav>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="pt-24 px-4 md:px-8 max-w-[1600px] mx-auto pb-12 print-hidden">
        
        <!-- CABEÇALHO -->
        <div class="flex flex-col xl:flex-row xl:items-end justify-between gap-6 mb-10">
            <div>
                <h2 class="text-3xl font-black tracking-tight text-black uppercase">Consolidado Regional</h2>
                <p class="text-gray-400 font-medium mt-1">Visão estratégica dos setores e congregações.</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <button onclick="requestAdminAccess()" class="flex items-center gap-2 bg-black text-white px-5 py-2.5 rounded-xl text-xs font-bold uppercase shadow-sm hover:bg-gray-800 transition-colors">
                    <i data-lucide="lock" class="w-4 h-4"></i> Admin
                </button>
                <button onclick="showPrintSelection()" class="flex items-center gap-2 border border-black text-black px-5 py-2.5 rounded-xl text-xs font-bold uppercase hover:bg-gray-50 transition-all">
                    <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                </button>

                <div class="flex flex-wrap items-center bg-gray-50 border border-gray-100 rounded-xl p-1">
                    <select id="yearFilter" class="bg-transparent pl-3 pr-8 py-2 text-[10px] font-black uppercase outline-none border-r border-gray-200" onchange="updateDashboard()">
                        <option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option>
                    </select>
                    <select id="sectorFilter" class="bg-transparent pl-3 pr-8 py-2 text-[10px] font-black uppercase outline-none border-r border-gray-200" onchange="onSectorChange()">
                        <option value="Todos">Todos Setores</option>
                        <option value="JARDIM ALMANARA">Setor Almanara</option>
                        <option value="VILA ACRE">Setor Vila Acre</option>
                        <option value="CASA VERDE ALTA">Setor Casa Verde</option>
                        <option value="VILA SANTA MARIA">Setor Vila Santa Maria</option>
                    </select>
                    <select id="churchFilter" class="bg-transparent pl-3 pr-8 py-2 text-[10px] font-black uppercase outline-none" onchange="updateDashboard()">
                        <option value="Todas">Todas Igrejas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- INDICADORES -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="card-clean p-6 rounded-3xl">
                <p class="text-[10px] font-black uppercase text-gray-400 mb-2">Entradas Totais</p>
                <p id="kpi-income" class="text-2xl font-black text-emerald-600">R$ 0,00</p>
            </div>
            <div class="card-clean p-6 rounded-3xl">
                <p class="text-[10px] font-black uppercase text-gray-400 mb-2">Saídas Totais</p>
                <p id="kpi-expense" class="text-2xl font-black text-rose-600">R$ 0,00</p>
            </div>
            <div class="card-clean p-6 rounded-3xl">
                <p class="text-[10px] font-black uppercase text-gray-400 mb-2">Saldo Regional</p>
                <p id="kpi-balance" class="text-2xl font-black text-blue-600">R$ 0,00</p>
            </div>
            <div class="card-clean p-6 rounded-3xl">
                <p class="text-[10px] font-black uppercase text-gray-400 mb-2">Atividade</p>
                <p id="kpi-active" class="text-2xl font-black text-black">0 Unidades</p>
            </div>
        </div>

        <!-- GRÁFICOS -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
            <div class="lg:col-span-8 bg-white p-8 rounded-[40px] border border-gray-100 shadow-sm">
                <h3 class="font-black text-lg uppercase mb-6 flex items-center gap-3">
                    <span class="w-1.5 h-6 bg-black rounded-full"></span> Comparativo Mensal (BARRAS)
                </h3>
                <div class="h-[400px]"><canvas id="mainChart"></canvas></div>
            </div>
            <div class="lg:col-span-4 bg-white p-8 rounded-[40px] border border-gray-100 shadow-sm">
                <h3 class="font-black text-lg uppercase mb-6 flex items-center gap-3">
                    <span class="w-1.5 h-6 bg-black rounded-full"></span> Saúde Financeira
                </h3>
                <div class="h-[400px]"><canvas id="pieChart"></canvas></div>
            </div>
            <div class="lg:col-span-12 bg-white p-8 rounded-[40px] border border-gray-100 shadow-sm">
                <h3 class="font-black text-lg uppercase mb-6 flex items-center gap-3">
                    <span class="w-1.5 h-6 bg-black rounded-full"></span> Ranking de Saldo (Unidades)
                </h3>
                <div class="h-[400px]"><canvas id="rankingChart"></canvas></div>
            </div>
        </div>

        <!-- TABELA OCULTA POR PADRÃO -->
        <div id="tableSection" class="bg-white border border-gray-100 rounded-[40px] overflow-hidden hidden transition-all duration-500">
            <div class="p-8 border-b border-gray-50 flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div>
                    <h3 class="font-black text-xl tracking-tight text-black uppercase">Relatório de Lançamentos</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase mt-1">Listagem individual por competência</p>
                </div>
                <div class="relative w-full md:w-80">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-300"></i>
                    <input type="text" id="tableSearch" placeholder="Pesquisar igreja..." class="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-2xl text-sm font-medium outline-none border-none focus:ring-1 ring-black" onkeyup="renderTable()">
                </div>
            </div>
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="bg-gray-50/50 text-gray-400 font-black text-[10px] uppercase border-b border-gray-50 tracking-widest">
                            <th class="px-8 py-5">Igreja</th>
                            <th class="px-6 py-5">Ano</th>
                            <th class="px-6 py-5 text-center">Mês</th>
                            <th class="px-6 py-5 text-right">Créditos</th>
                            <th class="px-6 py-5 text-right">Débitos</th>
                            <th class="px-8 py-5 text-right">Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </div>
        
        <!-- BOTÃO PARA VER TABELA -->
        <div id="tableToggleContainer" class="flex justify-center mt-10">
            <button onclick="toggleTableVisibility()" class="flex items-center gap-2 px-8 py-3 bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-2xl text-[10px] font-black uppercase transition-all">
                <i data-lucide="list" class="w-4 h-4"></i> <span id="toggleText">Ver Listagem Completa</span>
            </button>
        </div>
    </main>

    <!-- MODAIS -->
    <div id="passwordModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[150] hidden items-center justify-center p-4">
        <div class="bg-white rounded-[40px] p-12 max-w-sm w-full text-center shadow-2xl">
            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-8">
                <i data-lucide="shield-check" class="w-10 h-10 text-black"></i>
            </div>
            <h4 class="font-black text-2xl text-black mb-2 uppercase tracking-tighter">Acesso Restrito</h4>
            <input type="password" id="adminPasswordInput" placeholder="••••" class="w-full text-center p-5 bg-gray-50 rounded-3xl border-none outline-none focus:ring-2 ring-black mb-6 text-3xl tracking-[0.8em]">
            <button onclick="checkAdminPassword()" class="w-full py-5 bg-black text-white rounded-3xl text-xs font-black uppercase hover:scale-[1.02] transition-all shadow-xl shadow-black/20">Acessar</button>
            <button onclick="closeModal('passwordModal')" class="mt-6 text-[10px] font-black text-gray-300 uppercase hover:text-gray-500">Voltar</button>
        </div>
    </div>

    <!-- MODAL ADMIN -->
    <div id="adminModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl rounded-[40px] shadow-2xl overflow-hidden animate-in zoom-in duration-200">
            <div class="p-8 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h3 class="font-black uppercase text-xl text-black tracking-tighter">Painel Adm</h3>
                </div>
                <div class="flex gap-2">
                    <button id="tabManualBtn" onclick="switchAdminTab('manual')" class="px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase bg-black text-white">Manual</button>
                    <button id="tabBulkBtn" onclick="switchAdminTab('bulk')" class="px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase bg-gray-100 text-gray-400">Massa</button>
                    <button onclick="exitAdmin()" class="btn-exit px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase">Sair</button>
                </div>
            </div>
            
            <div id="tabManual" class="p-10 space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <select id="adminYear" class="p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 ring-black font-bold">
                        <option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option>
                    </select>
                    <select id="adminMonth" class="p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 ring-black font-bold"></select>
                </div>
                <select id="adminSector" onchange="onAdminSectorChange()" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 ring-black font-bold">
                    <option value="JARDIM ALMANARA">Setor Jardim Almanara</option>
                    <option value="VILA ACRE">Setor Vila Acre</option>
                    <option value="CASA VERDE ALTA">Setor Casa Verde Alta</option>
                    <option value="VILA SANTA MARIA">Setor Vila Santa Maria</option>
                </select>
                <select id="adminChurch" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 ring-black font-bold"></select>
                <div class="grid grid-cols-2 gap-6">
                    <input type="number" id="adminIncome" placeholder="Créditos" step="0.01" class="p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 ring-emerald-500 font-black">
                    <input type="number" id="adminExpense" placeholder="Débitos" step="0.01" class="p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 ring-rose-500 font-black">
                </div>
                <button onclick="saveAdminData()" class="w-full py-5 bg-black text-white rounded-3xl text-xs font-black uppercase shadow-xl flex items-center justify-center gap-2">Salvar Registro</button>
            </div>

            <div id="tabBulk" class="p-10 space-y-6 hidden">
                <textarea id="bulkDataInput" rows="8" placeholder="Cole os dados aqui..." class="w-full p-6 bg-gray-50 rounded-[24px] text-[11px] font-mono border-none outline-none focus:ring-1 ring-black custom-scrollbar"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <select id="bulkYear" class="p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-1 ring-black font-bold">
                        <option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option>
                    </select>
                    <button onclick="processBulkPaste()" class="py-4 bg-emerald-600 text-white rounded-2xl text-[10px] font-black uppercase shadow-lg">Salvar Lote</button>
                </div>
                <button onclick="resetRegionalData()" class="w-full py-4 text-[10px] font-black text-rose-500 uppercase">Zerar Regional</button>
            </div>
        </div>
    </div>

    <!-- FEEDBACK -->
    <div id="feedbackModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div class="bg-white rounded-[40px] p-10 max-w-xs w-full text-center shadow-2xl">
            <h4 id="feedbackTitle" class="font-black text-black mb-2 uppercase">Aviso</h4>
            <p id="feedbackText" class="text-sm text-gray-400 font-medium mb-8"></p>
            <button onclick="closeModal('feedbackModal')" class="w-full py-4 bg-black text-white rounded-2xl text-[10px] font-black uppercase">OK</button>
        </div>
    </div>

    <div id="printSelectionModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[150] hidden items-center justify-center p-4">
        <div class="bg-white rounded-[40px] p-10 max-w-md w-full text-center shadow-2xl">
            <h4 class="font-black text-xl uppercase mb-8">Gerar Relatório A4</h4>
            <div id="printOptsContainer" class="space-y-4 mb-10 text-left"></div>
            <div class="flex gap-4">
                <button onclick="closeModal('printSelectionModal')" class="flex-1 py-4 text-[10px] font-black text-gray-300 uppercase">Cancelar</button>
                <button onclick="executePrint()" class="flex-2 px-10 py-4 bg-black text-white rounded-3xl text-[10px] font-black uppercase">Imprimir</button>
            </div>
        </div>
    </div>

    <div id="printContainer" class="hidden"></div>

    <script>
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'regional-santa-maria-clean-final-v4';

        const SECTORS = {
            "JARDIM ALMANARA": ["Jardim Almanara", "Parque Pedroso", "Vila Penteado", "Jardim dos Francos"],
            "VILA ACRE": ["Vila Acre", "Jardim das Graças", "Trivelato"],
            "CASA VERDE ALTA": ["Casa Verde Alta", "Casa Verde 2", "Vila Santista"],
            "VILA SANTA MARIA": ["Vila Santa Maria"]
        };

        const ALL_CHURCHES = Object.values(SECTORS).flat();
        const MONTHS = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const FULL_MONTHS = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        let currentData = [];
        let mainChart, pieChart, rankingChart;
        let isTableVisible = false;

        window.onload = async () => {
            lucide.createIcons();
            initChurchOptions();
            generateSelectors();
            
            try {
                const initAuth = async () => {
                  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                  } else {
                    await auth.signInAnonymously();
                  }
                };
                await initAuth();
                
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        setupFirestoreListener();
                    } else {
                        updateSyncStatus('error', 'Não Autenticado');
                    }
                });
            } catch (e) { 
                console.error(e);
                updateSyncStatus('error', 'Falha na Conexão');
            }
        };

        function generateSelectors() {
            document.getElementById('adminMonth').innerHTML = MONTHS.map((m, i) => `<option value="${m}">${FULL_MONTHS[i]}</option>`).join('');
            const printList = [
                {id: 'printMain', t: 'Evolução Mensal Regional'},
                {id: 'printPie', t: 'Análise Saúde Financeira'},
                {id: 'printRanking', t: 'Ranking por Congregação'}
            ];
            document.getElementById('printOptsContainer').innerHTML = printList.map(p => `
                <label class="flex items-center gap-4 p-5 bg-gray-50 rounded-[24px] cursor-pointer hover:bg-gray-100 transition-all">
                    <input type="checkbox" id="${p.id}" checked class="w-5 h-5 accent-black">
                    <span class="text-[10px] font-black uppercase text-gray-600">${p.t}</span>
                </label>
            `).join('');
        }

        function initChurchOptions() {
            const filter = document.getElementById('churchFilter');
            filter.innerHTML = '<option value="Todas">Todas Igrejas</option>';
            ALL_CHURCHES.sort().forEach(n => {
                const o = document.createElement('option');
                o.value = n; o.textContent = n; filter.appendChild(o);
            });
        }

        function onSectorChange() {
            const sector = document.getElementById('sectorFilter').value;
            const churchFilter = document.getElementById('churchFilter');
            churchFilter.innerHTML = '<option value="Todas">Todas Igrejas</option>';
            const list = sector === "Todos" ? ALL_CHURCHES : SECTORS[sector];
            list.sort().forEach(n => {
                const o = document.createElement('option');
                o.value = n; o.textContent = n; churchFilter.appendChild(o);
            });
            updateDashboard();
        }

        async function setupFirestoreListener() {
            if (!auth.currentUser) return;
            const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records');
            col.onSnapshot(snap => {
                if (snap.empty) { seedInitialData(col); return; }
                currentData = snap.docs.map(d => d.data());
                updateDashboard();
                updateSyncStatus('connected', 'Sincronizado');
            }, (error) => {
                console.error("Firestore Error:", error);
                updateSyncStatus('error', 'Sem Permissão');
            });
        }

        async function seedInitialData(col) {
            if (!auth.currentUser) return;
            const batch = db.batch();
            ALL_CHURCHES.forEach(church => {
                [2023, 2024, 2025].forEach(year => {
                    for (let m = 0; m < 12; m++) {
                        batch.set(col.doc(`${church}_${year}_${m}`), {
                            church, year, month: MONTHS[m], income: 0, expense: 0, status: "Vazio"
                        });
                    }
                });
            });
            await batch.commit();
        }

        function requestAdminAccess() { document.getElementById('adminPasswordInput').value = ''; showModal('passwordModal'); }
        function checkAdminPassword() {
            if (document.getElementById('adminPasswordInput').value === "1234") {
                closeModal('passwordModal'); openAdminModal();
            } else { showFeedback("Erro", "Código regional inválido."); }
        }
        function exitAdmin() { closeModal('adminModal'); showFeedback("Modo Visualização", "Sessão encerrada."); }
        function openAdminModal() { onAdminSectorChange(); showModal('adminModal'); }
        function onAdminSectorChange() {
            const sector = document.getElementById('adminSector').value;
            document.getElementById('adminChurch').innerHTML = SECTORS[sector].map(c => `<option value="${c}">${c}</option>`).join('');
        }
        function switchAdminTab(tab) {
            const isManual = tab === 'manual';
            document.getElementById('tabManual').classList.toggle('hidden', !isManual);
            document.getElementById('tabBulk').classList.toggle('hidden', isManual);
        }

        async function resetRegionalData() {
            if (!auth.currentUser) return;
            if(!confirm("Zerar todos os dados?")) return;
            const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records');
            const snap = await col.get();
            const batch = db.batch();
            snap.docs.forEach(d => batch.update(d.ref, { income: 0, expense: 0, status: "Vazio" }));
            await batch.commit();
            showFeedback("Reset", "Dados regional zerados.");
        }

        async function processBulkPaste() {
            if (!auth.currentUser) return;
            const text = document.getElementById('bulkDataInput').value;
            const year = parseInt(document.getElementById('bulkYear').value);
            const lines = text.split('\n');
            const batch = db.batch();
            const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records');
            let count = 0;

            lines.forEach(line => {
                if (!line.trim()) return;
                const regex = /^(.*?)\s+(Jan|Fev|Mar|Abr|Mai|Jun|Jul|Ago|Set|Out|Nov|Dez)\s+R\$\s*([\d.,]+)\s+R\$\s*([\d.,]+)/i;
                const match = line.match(regex);
                if (match) {
                    const chName = match[1].trim();
                    const mName = match[2];
                    const incVal = parseFloat(match[3].replace(/\./g, '').replace(',', '.'));
                    const expVal = parseFloat(match[4].replace(/\./g, '').replace(',', '.'));
                    const church = ALL_CHURCHES.find(c => c.toLowerCase().includes(chName.toLowerCase())) || chName;
                    const mIdx = MONTHS.indexOf(mName.charAt(0).toUpperCase() + mName.slice(1).toLowerCase());
                    if (mIdx !== -1 && ALL_CHURCHES.includes(church)) {
                        batch.set(col.doc(`${church}_${year}_${mIdx}`), { church, year, month: MONTHS[mIdx], income: incVal, expense: expVal, status: "Real" }, { merge: true });
                        count++;
                    }
                }
            });
            if (count > 0) { await batch.commit(); closeModal('adminModal'); showFeedback("Sucesso", `${count} lançamentos.`); }
            else { showFeedback("Erro", "Formato não reconhecido."); }
        }

        async function saveAdminData() {
            if (!auth.currentUser) return;
            const ch = document.getElementById('adminChurch').value;
            const yr = parseInt(document.getElementById('adminYear').value);
            const mt = document.getElementById('adminMonth').value;
            const inc = parseFloat(document.getElementById('adminIncome').value) || 0;
            const exp = parseFloat(document.getElementById('adminExpense').value) || 0;
            const mIdx = MONTHS.indexOf(mt);
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records')
                .doc(`${ch}_${yr}_${mIdx}`).set({ church: ch, year: yr, month: mt, income: inc, expense: exp, status: "Real" }, { merge: true });
            closeModal('adminModal');
            showFeedback("Salvo", "Registro atualizado.");
        }

        function updateDashboard() {
            const year = parseInt(document.getElementById('yearFilter').value);
            const sector = document.getElementById('sectorFilter').value;
            const church = document.getElementById('churchFilter').value;
            let filtered = currentData.filter(d => d.year === year);
            if (sector !== "Todos") filtered = filtered.filter(d => SECTORS[sector].includes(d.church));
            if (church !== "Todas") filtered = filtered.filter(d => d.church === church);
            
            const totalInc = filtered.reduce((a, b) => a + b.income, 0);
            const totalExp = filtered.reduce((a, b) => a + b.expense, 0);
            const activeUnits = [...new Set(filtered.filter(d => d.income > 0).map(d => d.church))].length;

            document.getElementById('kpi-income').innerText = `R$ ${totalInc.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
            document.getElementById('kpi-expense').innerText = `R$ ${totalExp.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
            document.getElementById('kpi-balance').innerText = `R$ ${(totalInc - totalExp).toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
            document.getElementById('kpi-active').innerText = `${activeUnits} Unidades`;

            renderCharts(filtered);
            renderTable(filtered);
        }

        function renderCharts(data) {
            const incs = MONTHS.map(m => data.filter(d => d.month === m).reduce((a,b) => a+b.income, 0));
            const exps = MONTHS.map(m => data.filter(d => d.month === m).reduce((a,b) => a+b.expense, 0));

            if (mainChart) mainChart.destroy();
            mainChart = new Chart(document.getElementById('mainChart'), {
                type: 'bar', 
                data: {
                    labels: MONTHS,
                    datasets: [
                        { label: 'Entradas', data: incs, backgroundColor: '#10b981', borderRadius: 12 },
                        { label: 'Saídas', data: exps, backgroundColor: '#f43f5e', borderRadius: 12 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#f9fafb' } }, x: { grid: { display: false } } } }
            });

            if (pieChart) pieChart.destroy();
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Entradas', 'Saídas'],
                    datasets: [{ data: [total(incs) || 1, total(exps) || 0], backgroundColor: ['#000000', '#f3f4f6'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            const balances = ALL_CHURCHES.map(name => {
                const d = data.filter(i => i.church === name);
                return { n: name, b: d.reduce((a,c)=>a+c.income, 0) - d.reduce((a,c)=>a+c.expense, 0) };
            }).sort((a,b) => b.b - a.b);

            if (rankingChart) rankingChart.destroy();
            rankingChart = new Chart(document.getElementById('rankingChart'), {
                type: 'bar',
                data: {
                    labels: balances.map(x => x.n),
                    datasets: [{ data: balances.map(x => x.b), backgroundColor: balances.map(x => x.b >= 0 ? '#10b981' : '#f43f5e'), borderRadius: 8 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function toggleTableVisibility() {
            isTableVisible = !isTableVisible;
            document.getElementById('tableSection').classList.toggle('hidden', !isTableVisible);
            document.getElementById('toggleText').innerText = isTableVisible ? "Ocultar Listagem Detalhada" : "Ver Listagem Completa";
        }

        function renderTable(dataInput) {
            const search = document.getElementById('tableSearch').value.toLowerCase();
            const body = document.getElementById('dataTableBody');
            body.innerHTML = "";
            const rows = (dataInput || currentData).filter(d => d.church.toLowerCase().includes(search)).sort((a,b) => b.income - a.income);
            const finalRows = (document.getElementById('churchFilter').value === "Todas" && !search) ? rows.filter(r => r.income > 0 || r.expense > 0) : rows;

            if (finalRows.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-300 font-bold uppercase">Sem registros</td></tr>';
                return;
            }

            finalRows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-8 py-5 font-bold text-black">${r.church}</td>
                    <td class="px-6 py-5 text-gray-400 font-bold">${r.year}</td>
                    <td class="px-6 py-5 text-center text-gray-600 font-bold">${r.month}</td>
                    <td class="px-6 py-5 text-right text-emerald-600 font-black">R$ ${r.income.toLocaleString('pt-BR', {minFractionDigits:2})}</td>
                    <td class="px-6 py-5 text-right text-rose-500 font-black">R$ ${r.expense.toLocaleString('pt-BR', {minFractionDigits:2})}</td>
                    <td class="px-8 py-5 text-right font-black">R$ ${(r.income - r.expense).toLocaleString('pt-BR', {minFractionDigits:2})}</td>
                `;
                body.appendChild(tr);
            });
        }

        function updateSyncStatus(type, text) {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            dot.className = `w-2 h-2 rounded-full ${type === 'connected' ? 'bg-green-500 animate-pulse' : (type === 'error' ? 'bg-red-500' : 'bg-gray-300')}`;
            txt.innerText = text;
        }

        function showPrintSelection() { showModal('printSelectionModal'); }
        function executePrint() {
            const cont = document.getElementById('printContainer');
            cont.innerHTML = '';
            const opts = [{id:'printMain',t:'Fluxo Mensal',c:'mainChart'},{id:'printPie',t:'Saúde Financeira',c:'pieChart'},{id:'printRanking',t:'Ranking Regional',c:'rankingChart'}];
            opts.forEach(o => {
                if (document.getElementById(o.id).checked) {
                    const p = document.createElement('div');
                    p.className = 'print-page';
                    p.innerHTML = `<div style="text-align:center; border-bottom:3px solid #000; padding-bottom:10px; width:100%; margin-bottom:40px;"><h1 style="font-size:28px; font-weight:900;">AD.PERUS - REGIONAL SANTA MARIA</h1><p style="font-size:14px; font-weight:700; color:#666;">${o.t.toUpperCase()} | ANO: ${document.getElementById('yearFilter').value}</p></div><img src="${document.getElementById(o.c).toDataURL()}" style="width:100%; max-height:70%; object-fit:contain;"><div style="margin-top:40px; font-size:10px; color:#999; text-align:right; width:100%;">Emitido em: ${new Date().toLocaleString()}</div>`;
                    cont.appendChild(p);
                }
            });
            if (!cont.innerHTML) return;
            closeModal('printSelectionModal');
            setTimeout(() => window.print(), 500);
        }

        function showFeedback(title, text) { document.getElementById('feedbackTitle').innerText = title; document.getElementById('feedbackText').innerText = text; showModal('feedbackModal'); }
        function showModal(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
        const total = arr => arr.reduce((a, b) => a + b, 0);
    </script>
</body>
</html>
